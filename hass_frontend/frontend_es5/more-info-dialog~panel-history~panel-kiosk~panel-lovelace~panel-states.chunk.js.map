{"version":3,"sources":["webpack:///./src/common/datetime/format_date.ts","webpack:///./src/common/datetime/format_date_time.ts","webpack:///./src/common/datetime/format_time.ts","webpack:///./src/common/entity/compute_state_display.ts","webpack:///./src/components/entity/ha-chart-base.js","webpack:///./src/components/state-history-chart-line.js","webpack:///./src/components/state-history-chart-timeline.js","webpack:///./src/components/state-history-charts.js","webpack:///./src/data/cached-history.ts","webpack:///./src/data/ha-state-history-data.js","webpack:///./src/data/history.ts"],"names":["toLocaleDateStringSupportsOptions","Date","toLocaleDateString","e","name","dateObj","locales","year","month","day","fecha","format","toLocaleStringSupportsOptions","toLocaleString","hour","minute","toLocaleTimeStringSupportsOptions","toLocaleTimeString","localize","stateObj","language","display","domain","computeStateDomain","attributes","device_class","state","unit_of_measurement","includes","date","has_time","formatDate","has_date","now","getFullYear","getMonth","getDay","formatTime","formatDateTime","query_stage","scriptsLoaded","HaChartBase","_isAttached","onPropsChange","_resizeListener","_debouncer","Debouncer","debounce","timeOut","after","resizeChart","ResizeObserver","resizeObserver","entries","forEach","observe","$","chartTarget","addEventListener","then","ChartModule","ChartClass","unobserve","removeEventListener","_resizeTimer","undefined","clearInterval","data","drawChart","tooltip","opacity","set","yAlign","title","bodyLines","body","map","n","lines","i","colors","labelColors","color","borderColor","bgColor","backgroundColor","text","join","parentWidth","clientWidth","positionX","caretX","positionY","_chart","canvas","offsetTop","caretY","offsetLeft","Object","assign","left","top","event","window","stopPropagation","target","srcElement","nodeName","parentElement","index","model","itemsIndex","meta","getDatasetMeta","hidden","datasets","isDatasetVisible","update","chart","preserveVisibility","_oldIdentifier","identifier","x","label","metas","length","updateNeeded","unit","value","values","ctx","chartCanvas","type","cnt","constructor","getColorList","loopI","rgbString","alpha","rgbaString","_customTooltips","duration","isTimeline","options","scales","yAxes","gridLines","legend","_drawLegend","plugins","afterRender","_setRendered","responsive","maintainAspectRatio","animation","hover","animationDuration","responsiveAnimationDuration","tooltips","enabled","custom","bind","line","spanGaps","elements","font","ticks","fontFamily","Chart","helpers","merge","xAxes","callback","_formatTickValue","_colorFunc","getColorGenerator","staticColors","staticColorIndex","colorFunction","style","height","chartData","setInterval","_resizeChart","resize","areaTop","chartArea","areaBot","bottom","height1","clientHeight","_axisHeight","targetHeight","count","processL","Math","ceil","h1","result","Color","hsl","startIndex","palette","getColorIndex","idx","colorDict","colorIndex","keys","c","c1","isFinite","toLowerCase","getColor","__","ret","name1","html","String","rendered","Boolean","notify","readOnly","Array","xPadding","yPadding","rtl","reflectToAttribute","mixinBehaviors","IronResizableBehavior","PolymerElement","customElements","define","StateHistoryChartLine","animateHeight","requestAnimationFrame","scrollHeight","deviceStates","endTime","safeParseFloat","parsed","parseFloat","max","apply","devSts","states","last_changed","names","entity_id","prevValues","pushData","timestamp","datavalues","d","push","y","addColumn","nameY","step","fill","dataFill","dataStep","steppedLine","pointRadius","unitText","hasTargetRange","some","target_temp_high","target_temp_low","hasHeat","hasCool","curTemp","current_temperature","series","targetHigh","targetLow","temperature","isStep","lastValue","lastDate","lastNullDate","dateTime","getTime","lastNullDateTime","lastDateTime","tmpValue","prototype","formatTooltipTitle","items","item","datasetIndex","hass","chartOptions","isSingleDevice","major","fontStyle","maxTicksLimit","mode","callbacks","layout","padding","tension","borderWidth","point","hitRadius","filler","propagate","labels","observer","LocalizeMixin","StateHistoryChartTimeline","on","off","unavailable","unknown","idle","stateHistory","startTime","reduce","minTime","stateInfo","min","maxTime","newLastChanged","prevState","locState","prevLastChanged","entityDisplay","dataRow","newState","timeStamp","state_localize","formatTooltipLabel","start","end","afterSetDimensions","yaxe","maxWidth","width","position","_computeRTL","computeRTL","noSingle","computed","StateHistoryCharts","isLoadingData","historyData","historyDataEmpty","timeline","isLoading","upToNow","RECENT_THRESHOLD","RECENT_CACHE","stateHistoryCache","getRecent","entityId","cacheKey","cache","created","prom","fetchRecent","computeHistory","err","getEmptyCache","Promise","resolve","getRecentWithCache","cacheConfig","setHours","getHours","hoursToShow","toFetchStartTime","appendingToCache","curCacheProm","genProm","all","results","fetchedHistory","mergeLine","mergeTimeline","pruneStartTime","historyLines","cacheLines","oldLine","find","cacheLine","entity","oldEntity","cacheEntity","concat","historyTimelines","cacheTimelines","oldTimeline","cacheTimeline","pruneArray","originalStartTime","arr","changedAfterStartTime","findIndex","updateIndex","slice","cacheData","HaStateHistoryData","filterChangedDebouncer","filterType","_refreshTimeoutId","newHass","oldHass","_madeFirstCall","args","_debounceFilterChanged","filterChanged","fetchDate","dateHistory","getRecentWithCacheRefresh","_setIsLoading","_setData","refresh","DOMAINS_USE_LAST_UPDATED","LINE_ATTRIBUTES_TO_KEEP","skipInitialState","url","toISOString","callApi","equalState","obj1","obj2","every","attr","processTimelineEntity","computeStateDisplay","computeStateName","processLineChartEntities","entities","last","processedStates","processedState","last_updated","lineChartDevices","timelineDevices","stateWithUnit","config","unit_system","unitStates"],"mappings":"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","file":"more-info-dialog~panel-history~panel-kiosk~panel-lovelace~panel-states.chunk.js","sourcesContent":["import fecha from \"fecha\";\n\n// Check for support of native locale string options\nfunction toLocaleDateStringSupportsOptions() {\n  try {\n    new Date().toLocaleDateString(\"i\");\n  } catch (e) {\n    return e.name === \"RangeError\";\n  }\n  return false;\n}\n\nexport default (toLocaleDateStringSupportsOptions()\n  ? (dateObj: Date, locales: string) =>\n      dateObj.toLocaleDateString(locales, {\n        year: \"numeric\",\n        month: \"long\",\n        day: \"numeric\",\n      })\n  : (dateObj: Date) => fecha.format(dateObj, \"mediumDate\"));\n","import fecha from \"fecha\";\n\n// Check for support of native locale string options\nfunction toLocaleStringSupportsOptions() {\n  try {\n    new Date().toLocaleString(\"i\");\n  } catch (e) {\n    return e.name === \"RangeError\";\n  }\n  return false;\n}\n\nexport default (toLocaleStringSupportsOptions()\n  ? (dateObj: Date, locales: string) =>\n      dateObj.toLocaleString(locales, {\n        year: \"numeric\",\n        month: \"long\",\n        day: \"numeric\",\n        hour: \"numeric\",\n        minute: \"2-digit\",\n      })\n  : (dateObj: Date) => fecha.format(dateObj, \"haDateTime\"));\n","import fecha from \"fecha\";\n\n// Check for support of native locale string options\nfunction toLocaleTimeStringSupportsOptions() {\n  try {\n    new Date().toLocaleTimeString(\"i\");\n  } catch (e) {\n    return e.name === \"RangeError\";\n  }\n  return false;\n}\n\nexport default (toLocaleTimeStringSupportsOptions()\n  ? (dateObj: Date, locales: string) =>\n      dateObj.toLocaleTimeString(locales, {\n        hour: \"numeric\",\n        minute: \"2-digit\",\n      })\n  : (dateObj: Date) => fecha.format(dateObj, \"shortTime\"));\n","import { HassEntity } from \"home-assistant-js-websocket\";\nimport computeStateDomain from \"./compute_state_domain\";\nimport formatDateTime from \"../datetime/format_date_time\";\nimport formatDate from \"../datetime/format_date\";\nimport formatTime from \"../datetime/format_time\";\nimport { LocalizeFunc } from \"../translations/localize\";\n\nexport default (\n  localize: LocalizeFunc,\n  stateObj: HassEntity,\n  language: string\n): string => {\n  let display: string | undefined;\n  const domain = computeStateDomain(stateObj);\n\n  if (domain === \"binary_sensor\") {\n    // Try device class translation, then default binary sensor translation\n    if (stateObj.attributes.device_class) {\n      display = localize(\n        `state.${domain}.${stateObj.attributes.device_class}.${stateObj.state}`\n      );\n    }\n\n    if (!display) {\n      display = localize(`state.${domain}.default.${stateObj.state}`);\n    }\n  } else if (\n    stateObj.attributes.unit_of_measurement &&\n    ![\"unknown\", \"unavailable\"].includes(stateObj.state)\n  ) {\n    display = stateObj.state + \" \" + stateObj.attributes.unit_of_measurement;\n  } else if (domain === \"input_datetime\") {\n    let date: Date;\n    if (!stateObj.attributes.has_time) {\n      date = new Date(\n        stateObj.attributes.year,\n        stateObj.attributes.month - 1,\n        stateObj.attributes.day\n      );\n      display = formatDate(date, language);\n    } else if (!stateObj.attributes.has_date) {\n      const now = new Date();\n      date = new Date(\n        // Due to bugs.chromium.org/p/chromium/issues/detail?id=797548\n        // don't use artificial 1970 year.\n        now.getFullYear(),\n        now.getMonth(),\n        now.getDay(),\n        stateObj.attributes.hour,\n        stateObj.attributes.minute\n      );\n      display = formatTime(date, language);\n    } else {\n      date = new Date(\n        stateObj.attributes.year,\n        stateObj.attributes.month - 1,\n        stateObj.attributes.day,\n        stateObj.attributes.hour,\n        stateObj.attributes.minute\n      );\n      display = formatDateTime(date, language);\n    }\n  } else if (domain === \"zwave\") {\n    if ([\"initializing\", \"dead\"].includes(stateObj.state)) {\n      display = localize(\n        `state.zwave.query_stage.${stateObj.state}`,\n        \"query_stage\",\n        stateObj.attributes.query_stage\n      );\n    } else {\n      display = localize(`state.zwave.default.${stateObj.state}`);\n    }\n  } else {\n    display = localize(`state.${domain}.${stateObj.state}`);\n  }\n\n  // Fall back to default, component backend translation, or raw state if nothing else matches.\n  if (!display) {\n    display =\n      localize(`state.default.${stateObj.state}`) ||\n      localize(`component.${domain}.state.${stateObj.state}`) ||\n      stateObj.state;\n  }\n\n  return display;\n};\n","import { PolymerElement } from \"@polymer/polymer/polymer-element\";\nimport { IronResizableBehavior } from \"@polymer/iron-resizable-behavior/iron-resizable-behavior\";\nimport \"@polymer/paper-icon-button/paper-icon-button\";\nimport { html } from \"@polymer/polymer/lib/utils/html-tag\";\nimport { Debouncer } from \"@polymer/polymer/lib/utils/debounce\";\nimport { timeOut } from \"@polymer/polymer/lib/utils/async\";\nimport { mixinBehaviors } from \"@polymer/polymer/lib/legacy/class\";\n\nimport formatTime from \"../../common/datetime/format_time\";\n// eslint-disable-next-line no-unused-vars\n/* global Chart moment Color */\n\nlet scriptsLoaded = null;\n\nclass HaChartBase extends mixinBehaviors(\n  [IronResizableBehavior],\n  PolymerElement\n) {\n  static get template() {\n    return html`\n      <style>\n        :host {\n          display: block;\n        }\n        .chartHeader {\n          padding: 6px 0 0 0;\n          width: 100%;\n          display: flex;\n          flex-direction: row;\n        }\n        .chartHeader > div {\n          vertical-align: top;\n          padding: 0 8px;\n        }\n        .chartHeader > div.chartTitle {\n          padding-top: 8px;\n          flex: 0 0 0;\n          max-width: 30%;\n        }\n        .chartHeader > div.chartLegend {\n          flex: 1 1;\n          min-width: 70%;\n        }\n        :root {\n          user-select: none;\n          -moz-user-select: none;\n          -webkit-user-select: none;\n          -ms-user-select: none;\n        }\n        .chartTooltip {\n          font-size: 90%;\n          opacity: 1;\n          position: absolute;\n          background: rgba(80, 80, 80, 0.9);\n          color: white;\n          border-radius: 3px;\n          pointer-events: none;\n          transform: translate(-50%, 12px);\n          z-index: 1000;\n          width: 200px;\n          transition: opacity 0.15s ease-in-out;\n        }\n        :host([rtl]) .chartTooltip {\n          direction: rtl;\n        }\n        .chartLegend ul,\n        .chartTooltip ul {\n          display: inline-block;\n          padding: 0 0px;\n          margin: 5px 0 0 0;\n          width: 100%;\n        }\n        .chartTooltip li {\n          display: block;\n          white-space: pre-line;\n        }\n        .chartTooltip .title {\n          text-align: center;\n          font-weight: 500;\n        }\n        .chartLegend li {\n          display: inline-block;\n          padding: 0 6px;\n          max-width: 49%;\n          text-overflow: ellipsis;\n          white-space: nowrap;\n          overflow: hidden;\n          box-sizing: border-box;\n        }\n        .chartLegend li:nth-child(odd):last-of-type {\n          /* Make last item take full width if it is odd-numbered. */\n          max-width: 100%;\n        }\n        .chartLegend li[data-hidden] {\n          text-decoration: line-through;\n        }\n        .chartLegend em,\n        .chartTooltip em {\n          border-radius: 5px;\n          display: inline-block;\n          height: 10px;\n          margin-right: 4px;\n          width: 10px;\n        }\n        :host([rtl]) .chartTooltip em {\n          margin-right: inherit;\n          margin-left: 4px;\n        }\n        paper-icon-button {\n          color: var(--secondary-text-color);\n        }\n      </style>\n      <template is=\"dom-if\" if=\"[[unit]]\">\n        <div class=\"chartHeader\">\n          <div class=\"chartTitle\">[[unit]]</div>\n          <div class=\"chartLegend\">\n            <ul>\n              <template is=\"dom-repeat\" items=\"[[metas]]\">\n                <li on-click=\"_legendClick\" data-hidden$=\"[[item.hidden]]\">\n                  <em style$=\"background-color:[[item.bgColor]]\"></em>\n                  [[item.label]]\n                </li>\n              </template>\n            </ul>\n          </div>\n        </div>\n      </template>\n      <div id=\"chartTarget\" style=\"height:40px; width:100%\">\n        <canvas id=\"chartCanvas\"></canvas>\n        <div\n          class$=\"chartTooltip [[tooltip.yAlign]]\"\n          style$=\"opacity:[[tooltip.opacity]]; top:[[tooltip.top]]; left:[[tooltip.left]]; padding:[[tooltip.yPadding]]px [[tooltip.xPadding]]px\"\n        >\n          <div class=\"title\">[[tooltip.title]]</div>\n          <div>\n            <ul>\n              <template is=\"dom-repeat\" items=\"[[tooltip.lines]]\">\n                <li>\n                  <em style$=\"background-color:[[item.bgColor]]\"></em\n                  >[[item.text]]\n                </li>\n              </template>\n            </ul>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  get chart() {\n    return this._chart;\n  }\n\n  static get properties() {\n    return {\n      data: Object,\n      identifier: String,\n      rendered: {\n        type: Boolean,\n        notify: true,\n        value: false,\n        readOnly: true,\n      },\n      metas: {\n        type: Array,\n        value: () => [],\n      },\n      tooltip: {\n        type: Object,\n        value: () => ({\n          opacity: \"0\",\n          left: \"0\",\n          top: \"0\",\n          xPadding: \"5\",\n          yPadding: \"3\",\n        }),\n      },\n      unit: Object,\n      rtl: {\n        type: Boolean,\n        reflectToAttribute: true,\n      },\n    };\n  }\n\n  static get observers() {\n    return [\"onPropsChange(data)\"];\n  }\n\n  connectedCallback() {\n    super.connectedCallback();\n    this._isAttached = true;\n    this.onPropsChange();\n    this._resizeListener = () => {\n      this._debouncer = Debouncer.debounce(\n        this._debouncer,\n        timeOut.after(10),\n        () => {\n          if (this._isAttached) {\n            this.resizeChart();\n          }\n        }\n      );\n    };\n\n    if (typeof ResizeObserver === \"function\") {\n      this.resizeObserver = new ResizeObserver((entries) => {\n        entries.forEach(() => {\n          this._resizeListener();\n        });\n      });\n      this.resizeObserver.observe(this.$.chartTarget);\n    } else {\n      this.addEventListener(\"iron-resize\", this._resizeListener);\n    }\n\n    if (scriptsLoaded === null) {\n      scriptsLoaded = import(/* webpackChunkName: \"load_chart\" */ \"../../resources/ha-chart-scripts.js\");\n    }\n    scriptsLoaded.then((ChartModule) => {\n      this.ChartClass = ChartModule.default;\n      this.onPropsChange();\n    });\n  }\n\n  disconnectedCallback() {\n    super.disconnectedCallback();\n    this._isAttached = false;\n    if (this.resizeObserver) {\n      this.resizeObserver.unobserve(this.$.chartTarget);\n    }\n\n    this.removeEventListener(\"iron-resize\", this._resizeListener);\n\n    if (this._resizeTimer !== undefined) {\n      clearInterval(this._resizeTimer);\n      this._resizeTimer = undefined;\n    }\n  }\n\n  onPropsChange() {\n    if (!this._isAttached || !this.ChartClass || !this.data) {\n      return;\n    }\n    this.drawChart();\n  }\n\n  _customTooltips(tooltip) {\n    // Hide if no tooltip\n    if (tooltip.opacity === 0) {\n      this.set([\"tooltip\", \"opacity\"], 0);\n      return;\n    }\n    // Set caret Position\n    if (tooltip.yAlign) {\n      this.set([\"tooltip\", \"yAlign\"], tooltip.yAlign);\n    } else {\n      this.set([\"tooltip\", \"yAlign\"], \"no-transform\");\n    }\n\n    const title = tooltip.title ? tooltip.title[0] || \"\" : \"\";\n    this.set([\"tooltip\", \"title\"], title);\n\n    const bodyLines = tooltip.body.map((n) => n.lines);\n\n    // Set Text\n    if (tooltip.body) {\n      this.set(\n        [\"tooltip\", \"lines\"],\n        bodyLines.map((body, i) => {\n          const colors = tooltip.labelColors[i];\n          return {\n            color: colors.borderColor,\n            bgColor: colors.backgroundColor,\n            text: body.join(\"\\n\"),\n          };\n        })\n      );\n    }\n    const parentWidth = this.$.chartTarget.clientWidth;\n    let positionX = tooltip.caretX;\n    const positionY = this._chart.canvas.offsetTop + tooltip.caretY;\n    if (tooltip.caretX + 100 > parentWidth) {\n      positionX = parentWidth - 100;\n    } else if (tooltip.caretX < 100) {\n      positionX = 100;\n    }\n    positionX += this._chart.canvas.offsetLeft;\n    // Display, position, and set styles for font\n    this.tooltip = Object.assign({}, this.tooltip, {\n      opacity: 1,\n      left: `${positionX}px`,\n      top: `${positionY}px`,\n    });\n  }\n\n  _legendClick(event) {\n    event = event || window.event;\n    event.stopPropagation();\n    let target = event.target || event.srcElement;\n    while (target.nodeName !== \"LI\") {\n      // user clicked child, find parent LI\n      target = target.parentElement;\n    }\n    const index = event.model.itemsIndex;\n\n    const meta = this._chart.getDatasetMeta(index);\n    meta.hidden =\n      meta.hidden === null ? !this._chart.data.datasets[index].hidden : null;\n    this.set(\n      [\"metas\", index, \"hidden\"],\n      this._chart.isDatasetVisible(index) ? null : \"hidden\"\n    );\n    this._chart.update();\n  }\n\n  _drawLegend() {\n    const chart = this._chart;\n    // New data for old graph. Keep metadata.\n    const preserveVisibility =\n      this._oldIdentifier && this.identifier === this._oldIdentifier;\n    this._oldIdentifier = this.identifier;\n    this.set(\n      \"metas\",\n      this._chart.data.datasets.map((x, i) => ({\n        label: x.label,\n        color: x.color,\n        bgColor: x.backgroundColor,\n        hidden:\n          preserveVisibility && i < this.metas.length\n            ? this.metas[i].hidden\n            : !chart.isDatasetVisible(i),\n      }))\n    );\n    let updateNeeded = false;\n    if (preserveVisibility) {\n      for (let i = 0; i < this.metas.length; i++) {\n        const meta = chart.getDatasetMeta(i);\n        if (!!meta.hidden !== !!this.metas[i].hidden) updateNeeded = true;\n        meta.hidden = this.metas[i].hidden ? true : null;\n      }\n    }\n    if (updateNeeded) {\n      chart.update();\n    }\n    this.unit = this.data.unit;\n  }\n\n  _formatTickValue(value, index, values) {\n    if (values.length === 0) {\n      return value;\n    }\n    const date = new Date(values[index].value);\n    return formatTime(date);\n  }\n\n  drawChart() {\n    const data = this.data.data;\n    const ctx = this.$.chartCanvas;\n\n    if ((!data.datasets || !data.datasets.length) && !this._chart) {\n      return;\n    }\n    if (this.data.type !== \"timeline\" && data.datasets.length > 0) {\n      const cnt = data.datasets.length;\n      const colors = this.constructor.getColorList(cnt);\n      for (let loopI = 0; loopI < cnt; loopI++) {\n        data.datasets[loopI].borderColor = colors[loopI].rgbString();\n        data.datasets[loopI].backgroundColor = colors[loopI]\n          .alpha(0.6)\n          .rgbaString();\n      }\n    }\n\n    if (this._chart) {\n      this._customTooltips({ opacity: 0 });\n      this._chart.data = data;\n      this._chart.update({ duration: 0 });\n      if (this.isTimeline) {\n        this._chart.options.scales.yAxes[0].gridLines.display = data.length > 1;\n      } else if (this.data.legend === true) {\n        this._drawLegend();\n      }\n      this.resizeChart();\n    } else {\n      if (!data.datasets) {\n        return;\n      }\n      this._customTooltips({ opacity: 0 });\n      const plugins = [{ afterRender: () => this._setRendered(true) }];\n      let options = {\n        responsive: true,\n        maintainAspectRatio: false,\n        animation: {\n          duration: 0,\n        },\n        hover: {\n          animationDuration: 0,\n        },\n        responsiveAnimationDuration: 0,\n        tooltips: {\n          enabled: false,\n          custom: this._customTooltips.bind(this),\n        },\n        legend: {\n          display: false,\n        },\n        line: {\n          spanGaps: true,\n        },\n        elements: {\n          font: \"12px 'Roboto', 'sans-serif'\",\n        },\n        ticks: {\n          fontFamily: \"'Roboto', 'sans-serif'\",\n        },\n      };\n      options = Chart.helpers.merge(options, this.data.options);\n      options.scales.xAxes[0].ticks.callback = this._formatTickValue;\n      if (this.data.type === \"timeline\") {\n        this.set(\"isTimeline\", true);\n        if (this.data.colors !== undefined) {\n          this._colorFunc = this.constructor.getColorGenerator(\n            this.data.colors.staticColors,\n            this.data.colors.staticColorIndex\n          );\n        }\n        if (this._colorFunc !== undefined) {\n          options.elements.colorFunction = this._colorFunc;\n        }\n        if (data.datasets.length === 1) {\n          if (options.scales.yAxes[0].ticks) {\n            options.scales.yAxes[0].ticks.display = false;\n          } else {\n            options.scales.yAxes[0].ticks = { display: false };\n          }\n          if (options.scales.yAxes[0].gridLines) {\n            options.scales.yAxes[0].gridLines.display = false;\n          } else {\n            options.scales.yAxes[0].gridLines = { display: false };\n          }\n        }\n        this.$.chartTarget.style.height = \"50px\";\n      } else {\n        this.$.chartTarget.style.height = \"160px\";\n      }\n      const chartData = {\n        type: this.data.type,\n        data: this.data.data,\n        options: options,\n        plugins: plugins,\n      };\n      // Async resize after dom update\n      this._chart = new this.ChartClass(ctx, chartData);\n      if (this.isTimeline !== true && this.data.legend === true) {\n        this._drawLegend();\n      }\n      this.resizeChart();\n    }\n  }\n\n  resizeChart() {\n    if (!this._chart) return;\n    // Chart not ready\n    if (this._resizeTimer === undefined) {\n      this._resizeTimer = setInterval(this.resizeChart.bind(this), 10);\n      return;\n    }\n\n    clearInterval(this._resizeTimer);\n    this._resizeTimer = undefined;\n\n    this._resizeChart();\n  }\n\n  _resizeChart() {\n    const chartTarget = this.$.chartTarget;\n\n    const options = this.data;\n    const data = options.data;\n\n    if (data.datasets.length === 0) {\n      return;\n    }\n\n    if (!this.isTimeline) {\n      this._chart.resize();\n      return;\n    }\n\n    // Recalculate chart height for Timeline chart\n    const areaTop = this._chart.chartArea.top;\n    const areaBot = this._chart.chartArea.bottom;\n    const height1 = this._chart.canvas.clientHeight;\n    if (areaBot > 0) {\n      this._axisHeight = height1 - areaBot + areaTop;\n    }\n\n    if (!this._axisHeight) {\n      chartTarget.style.height = \"50px\";\n      this._chart.resize();\n      this.resizeChart();\n      return;\n    }\n    if (this._axisHeight) {\n      const cnt = data.datasets.length;\n      const targetHeight = 30 * cnt + this._axisHeight + \"px\";\n      if (chartTarget.style.height !== targetHeight) {\n        chartTarget.style.height = targetHeight;\n      }\n      this._chart.resize();\n    }\n  }\n\n  // Get HSL distributed color list\n  static getColorList(count) {\n    let processL = false;\n    if (count > 10) {\n      processL = true;\n      count = Math.ceil(count / 2);\n    }\n    const h1 = 360 / count;\n    const result = [];\n    for (let loopI = 0; loopI < count; loopI++) {\n      result[loopI] = Color().hsl(h1 * loopI, 80, 38);\n      if (processL) {\n        result[loopI + count] = Color().hsl(h1 * loopI, 80, 62);\n      }\n    }\n    return result;\n  }\n\n  static getColorGenerator(staticColors, startIndex) {\n    // Known colors for static data,\n    // should add for very common state string manually.\n    // Palette modified from http://google.github.io/palette.js/ mpn65, Apache 2.0\n    const palette = [\n      \"ff0029\",\n      \"66a61e\",\n      \"377eb8\",\n      \"984ea3\",\n      \"00d2d5\",\n      \"ff7f00\",\n      \"af8d00\",\n      \"7f80cd\",\n      \"b3e900\",\n      \"c42e60\",\n      \"a65628\",\n      \"f781bf\",\n      \"8dd3c7\",\n      \"bebada\",\n      \"fb8072\",\n      \"80b1d3\",\n      \"fdb462\",\n      \"fccde5\",\n      \"bc80bd\",\n      \"ffed6f\",\n      \"c4eaff\",\n      \"cf8c00\",\n      \"1b9e77\",\n      \"d95f02\",\n      \"e7298a\",\n      \"e6ab02\",\n      \"a6761d\",\n      \"0097ff\",\n      \"00d067\",\n      \"f43600\",\n      \"4ba93b\",\n      \"5779bb\",\n      \"927acc\",\n      \"97ee3f\",\n      \"bf3947\",\n      \"9f5b00\",\n      \"f48758\",\n      \"8caed6\",\n      \"f2b94f\",\n      \"eff26e\",\n      \"e43872\",\n      \"d9b100\",\n      \"9d7a00\",\n      \"698cff\",\n      \"d9d9d9\",\n      \"00d27e\",\n      \"d06800\",\n      \"009f82\",\n      \"c49200\",\n      \"cbe8ff\",\n      \"fecddf\",\n      \"c27eb6\",\n      \"8cd2ce\",\n      \"c4b8d9\",\n      \"f883b0\",\n      \"a49100\",\n      \"f48800\",\n      \"27d0df\",\n      \"a04a9b\",\n    ];\n    function getColorIndex(idx) {\n      // Reuse the color if index too large.\n      return Color(\"#\" + palette[idx % palette.length]);\n    }\n    const colorDict = {};\n    let colorIndex = 0;\n    if (startIndex > 0) colorIndex = startIndex;\n    if (staticColors) {\n      Object.keys(staticColors).forEach((c) => {\n        const c1 = staticColors[c];\n        if (isFinite(c1)) {\n          colorDict[c.toLowerCase()] = getColorIndex(c1);\n        } else {\n          colorDict[c.toLowerCase()] = Color(staticColors[c]);\n        }\n      });\n    }\n    // Custom color assign\n    function getColor(__, data) {\n      let ret;\n      const name = data[3];\n      if (name === null) return Color().hsl(0, 40, 38);\n      if (name === undefined) return Color().hsl(120, 40, 38);\n      const name1 = name.toLowerCase();\n      if (ret === undefined) {\n        ret = colorDict[name1];\n      }\n      if (ret === undefined) {\n        ret = getColorIndex(colorIndex);\n        colorIndex++;\n        colorDict[name1] = ret;\n      }\n      return ret;\n    }\n    return getColor;\n  }\n}\ncustomElements.define(\"ha-chart-base\", HaChartBase);\n","import \"@polymer/polymer/lib/utils/debounce\";\nimport { html } from \"@polymer/polymer/lib/utils/html-tag\";\nimport { PolymerElement } from \"@polymer/polymer/polymer-element\";\n\nimport \"./entity/ha-chart-base\";\n\nimport LocalizeMixin from \"../mixins/localize-mixin\";\nimport formatDateTime from \"../common/datetime/format_date_time\";\n\nclass StateHistoryChartLine extends LocalizeMixin(PolymerElement) {\n  static get template() {\n    return html`\n      <style>\n        :host {\n          display: block;\n          overflow: hidden;\n          height: 0;\n          transition: height 0.3s ease-in-out;\n        }\n      </style>\n      <ha-chart-base\n        id=\"chart\"\n        data=\"[[chartData]]\"\n        identifier=\"[[identifier]]\"\n        rendered=\"{{rendered}}\"\n      ></ha-chart-base>\n    `;\n  }\n\n  static get properties() {\n    return {\n      chartData: Object,\n      data: Object,\n      names: Object,\n      unit: String,\n      identifier: String,\n\n      isSingleDevice: {\n        type: Boolean,\n        value: false,\n      },\n\n      endTime: Object,\n      rendered: {\n        type: Boolean,\n        value: false,\n        observer: \"_onRenderedChanged\",\n      },\n    };\n  }\n\n  static get observers() {\n    return [\"dataChanged(data, endTime, isSingleDevice)\"];\n  }\n\n  connectedCallback() {\n    super.connectedCallback();\n    this._isAttached = true;\n    this.drawChart();\n  }\n\n  dataChanged() {\n    this.drawChart();\n  }\n\n  _onRenderedChanged(rendered) {\n    if (rendered) this.animateHeight();\n  }\n\n  animateHeight() {\n    requestAnimationFrame(() =>\n      requestAnimationFrame(() => {\n        this.style.height = this.$.chart.scrollHeight + \"px\";\n      })\n    );\n  }\n\n  drawChart() {\n    const unit = this.unit;\n    const deviceStates = this.data;\n    const datasets = [];\n    let endTime;\n\n    if (!this._isAttached) {\n      return;\n    }\n\n    if (deviceStates.length === 0) {\n      return;\n    }\n\n    function safeParseFloat(value) {\n      const parsed = parseFloat(value);\n      return isFinite(parsed) ? parsed : null;\n    }\n\n    endTime =\n      this.endTime ||\n      // Get the highest date from the last date of each device\n      new Date(\n        Math.max.apply(\n          null,\n          deviceStates.map(\n            (devSts) =>\n              new Date(devSts.states[devSts.states.length - 1].last_changed)\n          )\n        )\n      );\n    if (endTime > new Date()) {\n      endTime = new Date();\n    }\n\n    const names = this.names || {};\n    deviceStates.forEach((states) => {\n      const domain = states.domain;\n      const name = names[states.entity_id] || states.name;\n      // array containing [value1, value2, etc]\n      let prevValues;\n      const data = [];\n\n      function pushData(timestamp, datavalues) {\n        if (!datavalues) return;\n        if (timestamp > endTime) {\n          // Drop datapoints that are after the requested endTime. This could happen if\n          // endTime is \"now\" and client time is not in sync with server time.\n          return;\n        }\n        data.forEach((d, i) => {\n          d.data.push({ x: timestamp, y: datavalues[i] });\n        });\n        prevValues = datavalues;\n      }\n\n      function addColumn(nameY, step, fill) {\n        let dataFill = false;\n        let dataStep = false;\n        if (fill) {\n          dataFill = \"origin\";\n        }\n        if (step) {\n          dataStep = \"before\";\n        }\n        data.push({\n          label: nameY,\n          fill: dataFill,\n          steppedLine: dataStep,\n          pointRadius: 0,\n          data: [],\n          unitText: unit,\n        });\n      }\n\n      if (\n        domain === \"thermostat\" ||\n        domain === \"climate\" ||\n        domain === \"water_heater\"\n      ) {\n        // We differentiate between thermostats that have a target temperature\n        // range versus ones that have just a target temperature\n\n        // Using step chart by step-before so manually interpolation not needed.\n        const hasTargetRange = states.states.some(\n          (state) =>\n            state.attributes &&\n            state.attributes.target_temp_high !==\n              state.attributes.target_temp_low\n        );\n        const hasHeat = states.states.some((state) => state.state === \"heat\");\n        const hasCool = states.states.some((state) => state.state === \"cool\");\n\n        addColumn(name + \" current temperature\", true);\n        if (hasHeat) {\n          addColumn(name + \" heating\", true, true);\n          // The \"heating\" series uses steppedArea to shade the area below the current\n          // temperature when the thermostat is calling for heat.\n        }\n        if (hasCool) {\n          addColumn(name + \" cooling\", true, true);\n          // The \"cooling\" series uses steppedArea to shade the area below the current\n          // temperature when the thermostat is calling for heat.\n        }\n\n        if (hasTargetRange) {\n          addColumn(name + \" target temperature high\", true);\n          addColumn(name + \" target temperature low\", true);\n        } else {\n          addColumn(name + \" target temperature\", true);\n        }\n\n        states.states.forEach((state) => {\n          if (!state.attributes) return;\n          const curTemp = safeParseFloat(state.attributes.current_temperature);\n          const series = [curTemp];\n          if (hasHeat) {\n            series.push(state.state === \"heat\" ? curTemp : null);\n          }\n          if (hasCool) {\n            series.push(state.state === \"cool\" ? curTemp : null);\n          }\n          if (hasTargetRange) {\n            const targetHigh = safeParseFloat(\n              state.attributes.target_temp_high\n            );\n            const targetLow = safeParseFloat(state.attributes.target_temp_low);\n            series.push(targetHigh, targetLow);\n            pushData(new Date(state.last_changed), series);\n          } else {\n            const target = safeParseFloat(state.attributes.temperature);\n            series.push(target);\n            pushData(new Date(state.last_changed), series);\n          }\n        });\n      } else {\n        // Only disable interpolation for sensors\n        const isStep = domain === \"sensor\";\n        addColumn(name, isStep);\n\n        let lastValue = null;\n        let lastDate = null;\n        let lastNullDate = null;\n\n        // Process chart data.\n        // When state is `unknown`, calculate the value and break the line.\n        states.states.forEach((state) => {\n          const value = safeParseFloat(state.state);\n          const date = new Date(state.last_changed);\n          if (value !== null && lastNullDate !== null) {\n            const dateTime = date.getTime();\n            const lastNullDateTime = lastNullDate.getTime();\n            const lastDateTime = lastDate.getTime();\n            const tmpValue =\n              (value - lastValue) *\n                ((lastNullDateTime - lastDateTime) /\n                  (dateTime - lastDateTime)) +\n              lastValue;\n            pushData(lastNullDate, [tmpValue]);\n            pushData(new Date(lastNullDateTime + 1), [null]);\n            pushData(date, [value]);\n            lastDate = date;\n            lastValue = value;\n            lastNullDate = null;\n          } else if (value !== null && lastNullDate === null) {\n            pushData(date, [value]);\n            lastDate = date;\n            lastValue = value;\n          } else if (\n            value === null &&\n            lastNullDate === null &&\n            lastValue !== null\n          ) {\n            lastNullDate = date;\n          }\n        });\n      }\n\n      // Add an entry for final values\n      pushData(endTime, prevValues, false);\n\n      // Concat two arrays\n      Array.prototype.push.apply(datasets, data);\n    });\n\n    const formatTooltipTitle = (items, data) => {\n      const item = items[0];\n      const date = data.datasets[item.datasetIndex].data[item.index].x;\n\n      return formatDateTime(date, this.hass.language);\n    };\n\n    const chartOptions = {\n      type: \"line\",\n      unit: unit,\n      legend: !this.isSingleDevice,\n      options: {\n        scales: {\n          xAxes: [\n            {\n              type: \"time\",\n              ticks: {\n                major: {\n                  fontStyle: \"bold\",\n                },\n              },\n            },\n          ],\n          yAxes: [\n            {\n              ticks: {\n                maxTicksLimit: 7,\n              },\n            },\n          ],\n        },\n        tooltips: {\n          mode: \"neareach\",\n          callbacks: {\n            title: formatTooltipTitle,\n          },\n        },\n        hover: {\n          mode: \"neareach\",\n        },\n        layout: {\n          padding: {\n            top: 5,\n          },\n        },\n        elements: {\n          line: {\n            tension: 0.1,\n            pointRadius: 0,\n            borderWidth: 1.5,\n          },\n          point: {\n            hitRadius: 5,\n          },\n        },\n        plugins: {\n          filler: {\n            propagate: true,\n          },\n        },\n      },\n      data: {\n        labels: [],\n        datasets: datasets,\n      },\n    };\n    this.chartData = chartOptions;\n  }\n}\ncustomElements.define(\"state-history-chart-line\", StateHistoryChartLine);\n","import \"@polymer/polymer/lib/utils/debounce\";\nimport { html } from \"@polymer/polymer/lib/utils/html-tag\";\nimport { PolymerElement } from \"@polymer/polymer/polymer-element\";\n\nimport LocalizeMixin from \"../mixins/localize-mixin\";\n\nimport \"./entity/ha-chart-base\";\n\nimport formatDateTime from \"../common/datetime/format_date_time\";\nimport { computeRTL } from \"../common/util/compute_rtl\";\n\nclass StateHistoryChartTimeline extends LocalizeMixin(PolymerElement) {\n  static get template() {\n    return html`\n      <style>\n        :host {\n          display: block;\n          opacity: 0;\n          transition: opacity 0.3s ease-in-out;\n        }\n        :host([rendered]) {\n          opacity: 1;\n        }\n\n        ha-chart-base {\n          direction: ltr;\n        }\n      </style>\n      <ha-chart-base\n        data=\"[[chartData]]\"\n        rendered=\"{{rendered}}\"\n        rtl=\"{{rtl}}\"\n      ></ha-chart-base>\n    `;\n  }\n\n  static get properties() {\n    return {\n      hass: {\n        type: Object,\n      },\n      chartData: Object,\n      data: {\n        type: Object,\n        observer: \"dataChanged\",\n      },\n      names: Object,\n      noSingle: Boolean,\n      endTime: Date,\n      rendered: {\n        type: Boolean,\n        value: false,\n        reflectToAttribute: true,\n      },\n      rtl: {\n        reflectToAttribute: true,\n        computed: \"_computeRTL(hass)\",\n      },\n    };\n  }\n\n  static get observers() {\n    return [\"dataChanged(data, endTime, localize, language)\"];\n  }\n\n  connectedCallback() {\n    super.connectedCallback();\n    this._isAttached = true;\n    this.drawChart();\n  }\n\n  dataChanged() {\n    this.drawChart();\n  }\n\n  drawChart() {\n    const staticColors = {\n      on: 1,\n      off: 0,\n      unavailable: \"#a0a0a0\",\n      unknown: \"#606060\",\n      idle: 2,\n    };\n    let stateHistory = this.data;\n\n    if (!this._isAttached) {\n      return;\n    }\n\n    if (!stateHistory) {\n      stateHistory = [];\n    }\n\n    const startTime = new Date(\n      stateHistory.reduce(\n        (minTime, stateInfo) =>\n          Math.min(minTime, new Date(stateInfo.data[0].last_changed)),\n        new Date()\n      )\n    );\n\n    // end time is Math.max(startTime, last_event)\n    let endTime =\n      this.endTime ||\n      new Date(\n        stateHistory.reduce(\n          (maxTime, stateInfo) =>\n            Math.max(\n              maxTime,\n              new Date(stateInfo.data[stateInfo.data.length - 1].last_changed)\n            ),\n          startTime\n        )\n      );\n\n    if (endTime > new Date()) {\n      endTime = new Date();\n    }\n\n    const labels = [];\n    const datasets = [];\n    // stateHistory is a list of lists of sorted state objects\n    const names = this.names || {};\n    stateHistory.forEach((stateInfo) => {\n      let newLastChanged;\n      let prevState = null;\n      let locState = null;\n      let prevLastChanged = startTime;\n      const entityDisplay = names[stateInfo.entity_id] || stateInfo.name;\n\n      const dataRow = [];\n      stateInfo.data.forEach((state) => {\n        let newState = state.state;\n        const timeStamp = new Date(state.last_changed);\n        if (newState === undefined || newState === \"\") {\n          newState = null;\n        }\n        if (timeStamp > endTime) {\n          // Drop datapoints that are after the requested endTime. This could happen if\n          // endTime is 'now' and client time is not in sync with server time.\n          return;\n        }\n        if (prevState !== null && newState !== prevState) {\n          newLastChanged = new Date(state.last_changed);\n\n          dataRow.push([prevLastChanged, newLastChanged, locState, prevState]);\n\n          prevState = newState;\n          locState = state.state_localize;\n          prevLastChanged = newLastChanged;\n        } else if (prevState === null) {\n          prevState = newState;\n          locState = state.state_localize;\n          prevLastChanged = new Date(state.last_changed);\n        }\n      });\n\n      if (prevState !== null) {\n        dataRow.push([prevLastChanged, endTime, locState, prevState]);\n      }\n      datasets.push({ data: dataRow });\n      labels.push(entityDisplay);\n    });\n\n    const formatTooltipLabel = (item, data) => {\n      const values = data.datasets[item.datasetIndex].data[item.index];\n\n      const start = formatDateTime(values[0], this.hass.language);\n      const end = formatDateTime(values[1], this.hass.language);\n      const state = values[2];\n\n      return [state, start, end];\n    };\n\n    const chartOptions = {\n      type: \"timeline\",\n      options: {\n        tooltips: {\n          callbacks: {\n            label: formatTooltipLabel,\n          },\n        },\n        scales: {\n          xAxes: [\n            {\n              ticks: {\n                major: {\n                  fontStyle: \"bold\",\n                },\n              },\n            },\n          ],\n          yAxes: [\n            {\n              afterSetDimensions: (yaxe) => {\n                yaxe.maxWidth = yaxe.chart.width * 0.18;\n              },\n              position: this._computeRTL ? \"right\" : \"left\",\n            },\n          ],\n        },\n      },\n      data: {\n        labels: labels,\n        datasets: datasets,\n      },\n      colors: {\n        staticColors: staticColors,\n        staticColorIndex: 3,\n      },\n    };\n    this.chartData = chartOptions;\n  }\n\n  _computeRTL(hass) {\n    return computeRTL(hass);\n  }\n}\ncustomElements.define(\n  \"state-history-chart-timeline\",\n  StateHistoryChartTimeline\n);\n","import \"@polymer/paper-spinner/paper-spinner\";\nimport { html } from \"@polymer/polymer/lib/utils/html-tag\";\nimport { PolymerElement } from \"@polymer/polymer/polymer-element\";\n\nimport \"./state-history-chart-line\";\nimport \"./state-history-chart-timeline\";\n\nimport LocalizeMixin from \"../mixins/localize-mixin\";\n\nclass StateHistoryCharts extends LocalizeMixin(PolymerElement) {\n  static get template() {\n    return html`\n      <style>\n        :host {\n          display: block;\n          /* height of single timeline chart = 58px */\n          min-height: 58px;\n        }\n        .info {\n          text-align: center;\n          line-height: 58px;\n          color: var(--secondary-text-color);\n        }\n      </style>\n      <template\n        is=\"dom-if\"\n        class=\"info\"\n        if=\"[[_computeIsLoading(isLoadingData)]]\"\n      >\n        <div class=\"info\">\n          [[localize('ui.components.history_charts.loading_history')]]\n        </div>\n      </template>\n\n      <template\n        is=\"dom-if\"\n        class=\"info\"\n        if=\"[[_computeIsEmpty(isLoadingData, historyData)]]\"\n      >\n        <div class=\"info\">\n          [[localize('ui.components.history_charts.no_history_found')]]\n        </div>\n      </template>\n\n      <template is=\"dom-if\" if=\"[[historyData.timeline.length]]\">\n        <state-history-chart-timeline\n          hass=\"[[hass]]\"\n          data=\"[[historyData.timeline]]\"\n          end-time=\"[[_computeEndTime(endTime, upToNow, historyData)]]\"\n          no-single=\"[[noSingle]]\"\n          names=\"[[names]]\"\n        ></state-history-chart-timeline>\n      </template>\n\n      <template is=\"dom-repeat\" items=\"[[historyData.line]]\">\n        <state-history-chart-line\n          hass=\"[[hass]]\"\n          unit=\"[[item.unit]]\"\n          data=\"[[item.data]]\"\n          identifier=\"[[item.identifier]]\"\n          is-single-device=\"[[_computeIsSingleLineChart(item.data, noSingle)]]\"\n          end-time=\"[[_computeEndTime(endTime, upToNow, historyData)]]\"\n          names=\"[[names]]\"\n        ></state-history-chart-line>\n      </template>\n    `;\n  }\n\n  static get properties() {\n    return {\n      hass: Object,\n      historyData: {\n        type: Object,\n        value: null,\n      },\n      names: Object,\n\n      isLoadingData: Boolean,\n\n      endTime: {\n        type: Object,\n      },\n\n      upToNow: Boolean,\n      noSingle: Boolean,\n    };\n  }\n\n  _computeIsSingleLineChart(data, noSingle) {\n    return !noSingle && data && data.length === 1;\n  }\n\n  _computeIsEmpty(isLoadingData, historyData) {\n    const historyDataEmpty =\n      !historyData ||\n      !historyData.timeline ||\n      !historyData.line ||\n      (historyData.timeline.length === 0 && historyData.line.length === 0);\n    return !isLoadingData && historyDataEmpty;\n  }\n\n  _computeIsLoading(isLoading) {\n    return isLoading && !this.historyData;\n  }\n\n  _computeEndTime(endTime, upToNow) {\n    // We don't really care about the value of historyData, but if it change we want to update\n    // endTime.\n    return upToNow ? new Date() : endTime;\n  }\n}\ncustomElements.define(\"state-history-charts\", StateHistoryCharts);\n","import {\n  computeHistory,\n  fetchRecent,\n  HistoryResult,\n  TimelineEntity,\n  LineChartUnit,\n} from \"./history\";\nimport { HomeAssistant } from \"../types\";\nimport { HassEntity } from \"home-assistant-js-websocket\";\nimport { LocalizeFunc } from \"../common/translations/localize\";\n\ninterface CacheConfig {\n  refresh: number;\n  cacheKey: string;\n  hoursToShow: number;\n}\n\ninterface CachedResults {\n  prom: Promise<HistoryResult>;\n  startTime: Date;\n  endTime: Date;\n  language: string;\n  data: HistoryResult;\n}\n\n// This is a different interface, a different cache :(\ninterface RecentCacheResults {\n  created: number;\n  language: string;\n  data: Promise<HistoryResult>;\n}\n\nconst RECENT_THRESHOLD = 60000; // 1 minute\nconst RECENT_CACHE: { [cacheKey: string]: RecentCacheResults } = {};\nconst stateHistoryCache: { [cacheKey: string]: CachedResults } = {};\n\n// Cached type 1 unction. Without cache config.\nexport const getRecent = (\n  hass: HomeAssistant,\n  entityId: string,\n  startTime: Date,\n  endTime: Date,\n  localize: LocalizeFunc,\n  language: string\n) => {\n  const cacheKey = entityId;\n  const cache = RECENT_CACHE[cacheKey];\n\n  if (\n    cache &&\n    Date.now() - cache.created < RECENT_THRESHOLD &&\n    cache.language === language\n  ) {\n    return cache.data;\n  }\n\n  const prom = fetchRecent(hass, entityId, startTime, endTime).then(\n    (stateHistory) => computeHistory(hass, stateHistory, localize, language),\n    (err) => {\n      delete RECENT_CACHE[entityId];\n      throw err;\n    }\n  );\n\n  RECENT_CACHE[cacheKey] = {\n    created: Date.now(),\n    language,\n    data: prom,\n  };\n  return prom;\n};\n\n// Cache type 2 functionality\nfunction getEmptyCache(\n  language: string,\n  startTime: Date,\n  endTime: Date\n): CachedResults {\n  return {\n    prom: Promise.resolve({ line: [], timeline: [] }),\n    language,\n    startTime,\n    endTime,\n    data: { line: [], timeline: [] },\n  };\n}\n\nexport const getRecentWithCache = (\n  hass: HomeAssistant,\n  entityId: string,\n  cacheConfig: CacheConfig,\n  localize: LocalizeFunc,\n  language: string\n) => {\n  const cacheKey = cacheConfig.cacheKey;\n  const endTime = new Date();\n  const startTime = new Date(endTime);\n  startTime.setHours(startTime.getHours() - cacheConfig.hoursToShow);\n  let toFetchStartTime = startTime;\n  let appendingToCache = false;\n\n  let cache = stateHistoryCache[cacheKey];\n  if (\n    cache &&\n    toFetchStartTime >= cache.startTime &&\n    toFetchStartTime <= cache.endTime &&\n    cache.language === language\n  ) {\n    toFetchStartTime = cache.endTime;\n    appendingToCache = true;\n    // This pretty much never happens as endTime is usually set to now\n    if (endTime <= cache.endTime) {\n      return cache.prom;\n    }\n  } else {\n    cache = stateHistoryCache[cacheKey] = getEmptyCache(\n      language,\n      startTime,\n      endTime\n    );\n  }\n\n  const curCacheProm = cache.prom;\n\n  const genProm = async () => {\n    let fetchedHistory: HassEntity[][];\n\n    try {\n      const results = await Promise.all([\n        curCacheProm,\n        fetchRecent(\n          hass,\n          entityId,\n          toFetchStartTime,\n          endTime,\n          appendingToCache\n        ),\n      ]);\n      fetchedHistory = results[1];\n    } catch (err) {\n      delete stateHistoryCache[cacheKey];\n      throw err;\n    }\n    const stateHistory = computeHistory(\n      hass,\n      fetchedHistory,\n      localize,\n      language\n    );\n    if (appendingToCache) {\n      mergeLine(stateHistory.line, cache.data.line);\n      mergeTimeline(stateHistory.timeline, cache.data.timeline);\n      pruneStartTime(startTime, cache.data);\n    } else {\n      cache.data = stateHistory;\n    }\n    return cache.data;\n  };\n\n  cache.prom = genProm();\n  cache.startTime = startTime;\n  cache.endTime = endTime;\n  return cache.prom;\n};\n\nconst mergeLine = (\n  historyLines: LineChartUnit[],\n  cacheLines: LineChartUnit[]\n) => {\n  historyLines.forEach((line) => {\n    const unit = line.unit;\n    const oldLine = cacheLines.find((cacheLine) => cacheLine.unit === unit);\n    if (oldLine) {\n      line.data.forEach((entity) => {\n        const oldEntity = oldLine.data.find(\n          (cacheEntity) => entity.entity_id === cacheEntity.entity_id\n        );\n        if (oldEntity) {\n          oldEntity.states = oldEntity.states.concat(entity.states);\n        } else {\n          oldLine.data.push(entity);\n        }\n      });\n    } else {\n      cacheLines.push(line);\n    }\n  });\n};\n\nconst mergeTimeline = (\n  historyTimelines: TimelineEntity[],\n  cacheTimelines: TimelineEntity[]\n) => {\n  historyTimelines.forEach((timeline) => {\n    const oldTimeline = cacheTimelines.find(\n      (cacheTimeline) => cacheTimeline.entity_id === timeline.entity_id\n    );\n    if (oldTimeline) {\n      oldTimeline.data = oldTimeline.data.concat(timeline.data);\n    } else {\n      cacheTimelines.push(timeline);\n    }\n  });\n};\n\nconst pruneArray = (originalStartTime: Date, arr) => {\n  if (arr.length === 0) {\n    return arr;\n  }\n  const changedAfterStartTime = arr.findIndex(\n    (state) => new Date(state.last_changed) > originalStartTime\n  );\n  if (changedAfterStartTime === 0) {\n    // If all changes happened after originalStartTime then we are done.\n    return arr;\n  }\n\n  // If all changes happened at or before originalStartTime. Use last index.\n  const updateIndex =\n    changedAfterStartTime === -1 ? arr.length - 1 : changedAfterStartTime - 1;\n  arr[updateIndex].last_changed = originalStartTime;\n  return arr.slice(updateIndex);\n};\n\nconst pruneStartTime = (originalStartTime: Date, cacheData: HistoryResult) => {\n  cacheData.line.forEach((line) => {\n    line.data.forEach((entity) => {\n      entity.states = pruneArray(originalStartTime, entity.states);\n    });\n  });\n\n  cacheData.timeline.forEach((timeline) => {\n    timeline.data = pruneArray(originalStartTime, timeline.data);\n  });\n};\n","import { timeOut } from \"@polymer/polymer/lib/utils/async\";\nimport { Debouncer } from \"@polymer/polymer/lib/utils/debounce\";\nimport { PolymerElement } from \"@polymer/polymer/polymer-element\";\n\nimport LocalizeMixin from \"../mixins/localize-mixin\";\n\nimport { computeHistory, fetchDate } from \"./history\";\nimport { getRecent, getRecentWithCache } from \"./cached-history\";\n\n/*\n * @appliesMixin LocalizeMixin\n */\nclass HaStateHistoryData extends LocalizeMixin(PolymerElement) {\n  static get properties() {\n    return {\n      hass: {\n        type: Object,\n        observer: \"hassChanged\",\n      },\n\n      filterType: String,\n\n      cacheConfig: Object,\n\n      startTime: Date,\n      endTime: Date,\n\n      entityId: String,\n\n      isLoading: {\n        type: Boolean,\n        value: true,\n        readOnly: true,\n        notify: true,\n      },\n\n      data: {\n        type: Object,\n        value: null,\n        readOnly: true,\n        notify: true,\n      },\n    };\n  }\n\n  static get observers() {\n    return [\n      \"filterChangedDebouncer(filterType, entityId, startTime, endTime, cacheConfig, localize)\",\n    ];\n  }\n\n  connectedCallback() {\n    super.connectedCallback();\n    this.filterChangedDebouncer(\n      this.filterType,\n      this.entityId,\n      this.startTime,\n      this.endTime,\n      this.cacheConfig,\n      this.localize\n    );\n  }\n\n  disconnectedCallback() {\n    if (this._refreshTimeoutId) {\n      window.clearInterval(this._refreshTimeoutId);\n      this._refreshTimeoutId = null;\n    }\n    super.disconnectedCallback();\n  }\n\n  hassChanged(newHass, oldHass) {\n    if (!oldHass && !this._madeFirstCall) {\n      this.filterChangedDebouncer(\n        this.filterType,\n        this.entityId,\n        this.startTime,\n        this.endTime,\n        this.cacheConfig,\n        this.localize\n      );\n    }\n  }\n\n  filterChangedDebouncer(...args) {\n    this._debounceFilterChanged = Debouncer.debounce(\n      this._debounceFilterChanged,\n      timeOut.after(0),\n      () => {\n        this.filterChanged(...args);\n      }\n    );\n  }\n\n  filterChanged(\n    filterType,\n    entityId,\n    startTime,\n    endTime,\n    cacheConfig,\n    localize\n  ) {\n    if (!this.hass) {\n      return;\n    }\n    if (cacheConfig && !cacheConfig.cacheKey) {\n      return;\n    }\n    if (!localize) {\n      return;\n    }\n    this._madeFirstCall = true;\n    const language = this.hass.language;\n    let data;\n\n    if (filterType === \"date\") {\n      if (!startTime || !endTime) return;\n\n      data = fetchDate(this.hass, startTime, endTime).then((dateHistory) =>\n        computeHistory(this.hass, dateHistory, localize, language)\n      );\n    } else if (filterType === \"recent-entity\") {\n      if (!entityId) return;\n      if (cacheConfig) {\n        data = this.getRecentWithCacheRefresh(\n          entityId,\n          cacheConfig,\n          localize,\n          language\n        );\n      } else {\n        data = getRecent(\n          this.hass,\n          entityId,\n          startTime,\n          endTime,\n          localize,\n          language\n        );\n      }\n    } else {\n      return;\n    }\n    this._setIsLoading(true);\n\n    data.then((stateHistory) => {\n      this._setData(stateHistory);\n      this._setIsLoading(false);\n    });\n  }\n\n  getRecentWithCacheRefresh(entityId, cacheConfig, localize, language) {\n    if (this._refreshTimeoutId) {\n      window.clearInterval(this._refreshTimeoutId);\n      this._refreshTimeoutId = null;\n    }\n    if (cacheConfig.refresh) {\n      this._refreshTimeoutId = window.setInterval(() => {\n        getRecentWithCache(\n          this.hass,\n          entityId,\n          cacheConfig,\n          localize,\n          language\n        ).then((stateHistory) => {\n          this._setData(Object.assign({}, stateHistory));\n        });\n      }, cacheConfig.refresh * 1000);\n    }\n    return getRecentWithCache(\n      this.hass,\n      entityId,\n      cacheConfig,\n      localize,\n      language\n    );\n  }\n}\ncustomElements.define(\"ha-state-history-data\", HaStateHistoryData);\n","import computeStateName from \"../common/entity/compute_state_name\";\nimport computeStateDomain from \"../common/entity/compute_state_domain\";\nimport computeStateDisplay from \"../common/entity/compute_state_display\";\nimport { HassEntity } from \"home-assistant-js-websocket\";\nimport { HomeAssistant } from \"../types\";\nimport { LocalizeFunc } from \"../common/translations/localize\";\n\nconst DOMAINS_USE_LAST_UPDATED = [\"climate\", \"water_heater\"];\nconst LINE_ATTRIBUTES_TO_KEEP = [\n  \"temperature\",\n  \"current_temperature\",\n  \"target_temp_low\",\n  \"target_temp_high\",\n];\n\nexport interface LineChartState {\n  state: string;\n  last_changed: string;\n  attributes?: { [key: string]: any };\n}\n\nexport interface LineChartEntity {\n  domain: string;\n  name: string;\n  entity_id: string;\n  states: LineChartState[];\n}\n\nexport interface LineChartUnit {\n  unit: string;\n  identifier: string;\n  data: LineChartEntity[];\n}\n\nexport interface TimelineState {\n  state_localize: string;\n  state: string;\n  last_changed: string;\n}\n\nexport interface TimelineEntity {\n  name: string;\n  entity_id: string;\n  data: TimelineState[];\n}\n\nexport interface HistoryResult {\n  line: LineChartUnit[];\n  timeline: TimelineEntity[];\n}\n\nexport const fetchRecent = (\n  hass,\n  entityId,\n  startTime,\n  endTime,\n  skipInitialState = false\n): Promise<HassEntity[][]> => {\n  let url = \"history/period\";\n  if (startTime) {\n    url += \"/\" + startTime.toISOString();\n  }\n  url += \"?filter_entity_id=\" + entityId;\n  if (endTime) {\n    url += \"&end_time=\" + endTime.toISOString();\n  }\n  if (skipInitialState) {\n    url += \"&skip_initial_state\";\n  }\n\n  return hass.callApi(\"GET\", url);\n};\n\nexport const fetchDate = (\n  hass: HomeAssistant,\n  startTime: Date,\n  endTime: Date\n): Promise<HassEntity[][]> => {\n  return hass.callApi(\n    \"GET\",\n    `history/period/${startTime.toISOString()}?end_time=${endTime.toISOString()}`\n  );\n};\n\nconst equalState = (obj1: LineChartState, obj2: LineChartState) =>\n  obj1.state === obj2.state &&\n  // They either both have an attributes object or not\n  (!obj1.attributes ||\n    LINE_ATTRIBUTES_TO_KEEP.every(\n      (attr) => obj1.attributes![attr] === obj2.attributes![attr]\n    ));\n\nconst processTimelineEntity = (\n  localize: LocalizeFunc,\n  language: string,\n  states: HassEntity[]\n): TimelineEntity => {\n  const data: TimelineState[] = [];\n\n  for (const state of states) {\n    if (data.length > 0 && state.state === data[data.length - 1].state) {\n      continue;\n    }\n\n    data.push({\n      state_localize: computeStateDisplay(localize, state, language),\n      state: state.state,\n      last_changed: state.last_changed,\n    });\n  }\n\n  return {\n    name: computeStateName(states[0]),\n    entity_id: states[0].entity_id,\n    data,\n  };\n};\n\nconst processLineChartEntities = (\n  unit,\n  entities: HassEntity[][]\n): LineChartUnit => {\n  const data: LineChartEntity[] = [];\n\n  for (const states of entities) {\n    const last: HassEntity = states[states.length - 1];\n    const domain = computeStateDomain(last);\n    const processedStates: LineChartState[] = [];\n\n    for (const state of states) {\n      let processedState: LineChartState;\n\n      if (DOMAINS_USE_LAST_UPDATED.includes(domain)) {\n        processedState = {\n          state: state.state,\n          last_changed: state.last_updated,\n          attributes: {},\n        };\n\n        for (const attr of LINE_ATTRIBUTES_TO_KEEP) {\n          if (attr in state.attributes) {\n            processedState.attributes![attr] = state.attributes[attr];\n          }\n        }\n      } else {\n        processedState = state;\n      }\n\n      if (\n        processedStates.length > 1 &&\n        equalState(\n          processedState,\n          processedStates[processedStates.length - 1]\n        ) &&\n        equalState(processedState, processedStates[processedStates.length - 2])\n      ) {\n        continue;\n      }\n\n      processedStates.push(processedState);\n    }\n\n    data.push({\n      domain,\n      name: computeStateName(last),\n      entity_id: last.entity_id,\n      states: processedStates,\n    });\n  }\n\n  return {\n    unit,\n    identifier: entities.map((states) => states[0].entity_id).join(\"\"),\n    data,\n  };\n};\n\nexport const computeHistory = (\n  hass: HomeAssistant,\n  stateHistory: HassEntity[][],\n  localize: LocalizeFunc,\n  language: string\n): HistoryResult => {\n  const lineChartDevices: { [unit: string]: HassEntity[][] } = {};\n  const timelineDevices: TimelineEntity[] = [];\n  if (!stateHistory) {\n    return { line: [], timeline: [] };\n  }\n\n  stateHistory.forEach((stateInfo) => {\n    if (stateInfo.length === 0) {\n      return;\n    }\n\n    const stateWithUnit = stateInfo.find(\n      (state) => \"unit_of_measurement\" in state.attributes\n    );\n\n    let unit: string | undefined;\n\n    if (stateWithUnit) {\n      unit = stateWithUnit.attributes.unit_of_measurement;\n    } else if (computeStateDomain(stateInfo[0]) === \"climate\") {\n      unit = hass.config.unit_system.temperature;\n    } else if (computeStateDomain(stateInfo[0]) === \"water_heater\") {\n      unit = hass.config.unit_system.temperature;\n    }\n\n    if (!unit) {\n      timelineDevices.push(\n        processTimelineEntity(localize, language, stateInfo)\n      );\n    } else if (unit in lineChartDevices) {\n      lineChartDevices[unit].push(stateInfo);\n    } else {\n      lineChartDevices[unit] = [stateInfo];\n    }\n  });\n\n  const unitStates = Object.keys(lineChartDevices).map((unit) =>\n    processLineChartEntities(unit, lineChartDevices[unit])\n  );\n\n  return { line: unitStates, timeline: timelineDevices };\n};\n"],"sourceRoot":""}